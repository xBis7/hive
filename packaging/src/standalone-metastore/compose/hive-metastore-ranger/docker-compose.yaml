#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

version: '3.8'
services:
  postgres:
    image: 'postgres:latest'
    hostname: postgres
    ports:
      - '5433:5432' # Ranger postgres uses 5432
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: metastore_db
    healthcheck:
      test:  ["CMD", "psql", "-U", "postgres", "postgres"]
    networks:
      - ranger-net

  hive-metastore:
    image: ${HIVE_RUNNER_IMAGE}:${HIVE_RUNNER_VERSION}
# Enable privileged mode for creating a flamegraph.
# The extra permissions are needed for enabling CPU and kernel profiling on the container.
#    privileged: true
    hostname: hive-metastore
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - '9083:9083' # Metastore Thrift
      - '5005:5005' # Debugger
    volumes:
      - ../..:/opt/hive
      - ./ranger:/etc/ranger
      - ./conf:/opt/hive/conf
      - ./entrypoint.sh:/usr/local/bin/entrypoint.sh
    entrypoint: ["/usr/local/bin/entrypoint.sh"]
    environment:
      - HADOOP_HOME=/opt/hadoop
      - HIVE_HOME=/opt/hive
      - HADOOP_CLASSPATH=${HADOOP_HOME}/share/hadoop/tools/lib/*
      - PATH=${HIVE_HOME}/bin:${HADOOP_HOME}/bin:${PATH}
      - METASTORE_DB_HOSTNAME=postgres
    networks:
      - ranger-net

networks:
  ranger-net:
    name: rangernw
    external: true
